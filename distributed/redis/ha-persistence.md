# Redis高可用-持久化
## 高可用概述
Redis高可用主要包括一下几种方式：
* 持久化：严格意义上只有持久化不能称为高可用，主要是通过将数据存盘保证了数据的可靠性。Redis数据持久化包括2中：rdb和aof。
* 复制：复制是高可用的基础。对数据系统来说只有一份是无法实现高可用的。Redis通过master-slave实现数据主从复制（一主多从），可以实现读高可用，由于写入操作只能通过master节点，master宕机后写操作仍不可用。
* 哨兵：哨兵模式解决master宕机后自动选主。实现读写都可以高可用。
* 集群：严格意义上，集群也不是高可用的范畴。集群模式实现的是redis系统的扩展问题：scale-out。

## 持久化
Redis持久化分为`RDB持久化`和`AOF持久化`。前者将当前数据保存到硬盘，后者则是将每次执行的写命令保存到硬盘（类似于MySQL的Binlog）。由于AOF持久化的`实时性更好`，即当进程意外退出时丢失的数据更少，因此`AOF是目前主流的持久化方式`，不过RDB持久化仍然有其用武之地。
### RDB持久化
RDB持久化是将当前进程中的数据生成快照保存到硬盘（因此也称作`快照持久化`），保存的文件后缀是rdb；当Redis重新启动时，可以读取快照文件恢复数据。

RBD持久化的触发：
* 手动触发：save命令（生产中避免使用）和bgsave命令。
* 自动触发：配置文件中`save m n`指定当m秒内发生n次变化时，会触发bgsave。
* 主从复制场景下：如果从节点执行全量复制，主节点会执行bgsave命令，并将rdb文件发送给从节点；
* 执行shutdown命令时：自动执行rdb持久化。

RDB文件的载入工作是在服务器启动时自动执行的，并没有专门的命令。但是由于`AOF的优先级`更高，因此当AOF开启时，Redis会优先载入AOF文件来恢复数据；只有当AOF关闭时，才会在Redis服务器启动时检测RDB文件，并自动载入。服务器载入RDB文件期间处于阻塞状态，直到载入完成为止。

### AOF持久化
AOF持久化(即Append Only File持久化)，是将Redis执行的每次`写命令`记录到单独的日志文件中（有点像MySQL的binlog）；当Redis重启时再次执行AOF文件中的命令来恢复数据。

与RDB相比，AOF的`实时性更好`，因此已成为主流的持久化方案。

Redis服务器`默认开启RDB，关闭AOF`；要开启AOF，需要在配置文件中配置：
```ini
appendonly yes
```
AOF开启后，不需要明确的触发。

AOF执行过程：
1. 命令追加：该步骤把命令保存到一个缓冲区中。
2. 文本写入和文件同步：
    * always
    * no
    * everysec
3. 文件重写：AOF文件会持续增大。最后对其进行重写。

### RDB和AOF比较
| 持久化 | 优点 | 缺点 |
| - | :- | :- |
| RDB | RDB文件紧凑，体积小，网络传输快，适合全量复制；恢复速度比AOF快很多。与AOF相比，对性能的影响相对较小。 | 其数据快照的持久化方式决定了必然做不到实时持久化；RDB文件需要满足特定格式，兼容性差 |
| AOF | AOF的优点在于支持秒级持久化；兼容性好； | 缺点是文件大、恢复速度慢、对性能影响大。|