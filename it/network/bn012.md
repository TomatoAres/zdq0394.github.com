# 网络性能检测：吞吐量测量

网络路径性能检测主要包括三方面的内容：

* **带宽测量**能够获知网络的硬件特性，如网络的最大容量。
* **吞吐量测量**能够获得网络实际可提供的最大容量。
* **数据流测量**能够了解真实占用的网络容量。

本文介绍在评估网络性能是否合理时，需要收集的数据及收集方式。

涉及工具包括：ping, pathchar, bing, ttcp, netperf, iperf, netstat。

## 吞吐量测量

**吞吐量不够的原因不仅在于硬件不足，还有可能是网络设计架构的问题**。例如，广播域设置得太大，则即使硬件够磅也会造成问题。

解决方案是重构网络，在充分理解数据流模式后，将这类**域隔离开或是分段**。

吞吐量通常是**测量大块数据传输延时**来完成的。通常需要在链路各端运行软件。一般这类软件运行在**应用层**，所以它不仅测量网络也测量了软硬件。

一个比较简单粗放的方式是用FTP。用FTP来传输一份文件并且看一下它report的数据。需要将结果转换成比特率，例如，这是文件传输的最后一行：
1294522 bytes received in 1.44 secs (8.8e+02 Kbytes/sec)
将1,294,522字节乘8转换成bit之后再除以时间，1.44秒。 结果为7,191,789 bps。
**这种方法的不足在于磁盘访问时间可能对结果造成影响**。如果需要提高精度则需要使用一些工具。

### TTCP
运行这一程序首先需要在远端设备运行server，通常用-r和-s选项。之后运行client，用-t和-s选项，以及主机名或地址。

数据从client端发送至server端，测量性能之后，在各端返回结果，之后终止client端和server端。例如，server端如下所示：

	$ttcp -r -s
	ttcp-r: buflen=8192, nbuf=2048, align=16384/0, port=5001  tcp
	ttcp-r: socket
	ttcp-r: accept from 205.153.60.247
	ttcp-r: 16777216 bytes in 18.35 real seconds = 892.71 KB/sec +++
	ttcp-r: 11483 I/O calls, msec/call = 1.64, calls/sec = 625.67
	ttcp-r: 0.0user 0.9sys 0:18real 5% 15i+291d 176maxrss 0+2pf 11478+28csw

client端如下所示：

	$ ttcp -t -s 205.153.63.239
	ttcp-t: buflen=8192, nbuf=2048, align=16384/0, port=5001  tcp  -> 205.153.63.239
	ttcp-t: socket
	ttcp-t: connect
	ttcp-t: 16777216 bytes in 18.34 real seconds = 893.26 KB/sec +++
	ttcp-t: 2048 I/O calls, msec/call = 9.17, calls/sec = 111.66
	ttcp-t: 0.0user 0.5sys 0:18real 2% 16i+305d 176maxrss 0+2pf 3397+7csw
	
该程序报告中显示了信息传输总量，标识了连接的建立，并且给出了结果，包括raw data，throughput，I/O call信息，执行时间。最有用的信息应该是transfer rate，892.71 KB/sec (or 893.26 KB/sec)。

这一数据反映了**数据的传输速率，而不是链路的容量**。将这一数据转化成带宽可能是有问题的，因为实际上传输了比这一值更多的比特数。这一程序显示18.35秒传送了16,777,216字节，但是这仅仅是数据。以太网报文封装还包括TCP，IP，以太网报文头，估算容量时，需要把这些值加上去。

吞吐量低通常意味着拥塞，但也并不总是如此。吞吐量也会取决于配置问题，如连接的TCP窗口大小。如果窗口大小不足，会严重影响到性能。

