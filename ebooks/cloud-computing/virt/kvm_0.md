# KVM概述
## 虚拟化
在X86平台虚拟化技术中，新引入的虚拟化层通常称为虚拟机监控器（Virtual Machine Monitor,VMM），也叫做Hypervisor。

虚拟机监控器的运行环境，也就是真实的物理机平台，称之为**宿主机**。而虚拟出来的平台通常称为**客户机**，里面运行的操作系统对应地也称为**客户机操作系统**。

虚拟机监控器的主要职能是：管理真实的物理硬件平台，并为每个虚拟客户机提供对应的虚拟硬件平台。

***实现虚拟化的重要一步就在于：虚拟化层必须能够截获计算元件对物理资源的直接访问，并将其重定向到虚拟资源池中。***

“截获并重定向”的实现方式：软件虚拟化和硬件虚拟化。

**软件虚拟化**：纯软件的方法在现有的物理平台上实现对物理平台访问的截获和模拟。

QEMU：纯软件仿真，所有的指令都是软件模拟执行。

VMWare：动态二进制翻译，虚拟机监控器在可控制的范围内，允许客户机的指令在物理机平台上直接运行。

但是，客户机指令在运行前会被虚拟机监控器扫描，其中突破虚拟机监控器限制的指令会被动态替换为可以在物理平台上直接运行的安全指令。

**硬件虚拟化**：物理平台本身提供了对特殊指令的截获和重定向的硬件支持。

VMM将客户机置于一种受限制的模式下运行，一旦客户机试图访问物理资源，硬件会暂停客户机的运行，将控制权交回给VMM。

**准虚拟化**：改动客户机操作系统，是它认识到自己运行在虚拟化环境下，能够与虚拟机监控器系统工作。本质上，弱化了对虚拟机特殊指令的被动截获要求，将其转换成客户机操作系统的主动通知。XEN是准虚拟化的例子。

**全虚拟化**：全虚拟化为客户机提供了完整的虚拟X86平台。不需要修改操作系统。KVM

虚拟化模型：
		底层是整个物理系统，主要包括处理器、内存和输入输出设备
		物理系统之上，与以往熟悉的操作系统模型不同，运行的是虚拟机监控器。

虚拟化类型：

**类型一**：虚拟机是在系统上电之后首先加载运行VMM。

VMM一般会提供一个具有一定特权的特殊虚拟机，由这个特殊虚拟机来运行需要提供给用户日常操作和管理使用的操作系统环境。
		ESX/ESXi、Xen、Hyper-V

**类型二**：虚拟机监控程序，在系统上电之后仍然运行一般意义上的操作系统（俗称的宿主机操作系统）。

VMM作为特殊的应用程序，可以视作操作系统功能的扩展。KVM、Virtual Box、VMware Workstation
## KVM
KVM基于硬件虚拟化扩展（Intel VT或者AMD-V）技术，是Linux完全原生的全虚拟化解决方案。

KVM包含一个可加载的Kernel module: kvm.ko和一个处理器相关的module：kvm-intel.ko or kvm-amd.ko。

KVM是开源软件。KVM的核心组件从Linux2.6.20开始包含进主干。KVM的用户空间组件从1.3版本开始包含在QEMU主干中。

KVM本身不执行任何模拟，需要用户空间应用程序(QEMU)通过/dev/kvm接口设置一个客户机虚拟服务器的地址空间，向它提供模拟的I/O，并将它的视频显示映射回宿主的显示屏。

KVM仅支持硬件虚拟化。打开并初始化系统硬件以支持虚拟机的运行，是KVM模块的职责所在。

在被内载加载的时候，KVM模块会先初始化内部的数据结构；做好准备之后，KVM模块检测系统当前的CPU，然后打开CPU控制寄存器CR4中的虚拟化模式开关；通过执行VMXON指令将宿主操作系统（包括KVM模块本身）置于虚拟化模式中的根模式；最后，KVM模块创建特殊设备文件/dev/kvm并等待来自用户空间的命令（QEMU）。

虚拟机的创建和运行将是一个用户空间的应用程序QEMU和KVM模块相互配合的过程。


	